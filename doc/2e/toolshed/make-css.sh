readonly template="${1:?}"

# from Protesilaos Stavrou's modus-operandi theme
readonly o_bg_main='#ffffff' \
         o_bg_dim='#f2f2f2' \
         o_fg_main='#000000' \
         o_fg_dim='#595959' \
         o_fg_alt='#193668' \
         o_bg_active='#c4c4c4' \
         o_bg_inactive='#e0e0e0' \
         o_border='#9f9f9f' \
         o_red='#a60000' \
         o_red_warmer='#972500' \
         o_red_cooler='#a0132f' \
         o_red_faint='#7f0000' \
         o_red_intense='#d00000' \
         o_green='#006800' \
         o_green_warmer='#316500' \
         o_green_cooler='#00663f' \
         o_green_faint='#2a5045' \
         o_green_intense='#008900' \
         o_yellow='#6f5500' \
         o_yellow_warmer='#884900' \
         o_yellow_cooler='#7a4f2f' \
         o_yellow_faint='#624416' \
         o_yellow_intense='#808000' \
         o_blue='#0031a9' \
         o_blue_warmer='#3548cf' \
         o_blue_cooler='#0000b0' \
         o_blue_faint='#003497' \
         o_blue_intense='#0000ff' \
         o_magenta='#721045' \
         o_magenta_warmer='#8f0075' \
         o_magenta_cooler='#531ab6' \
         o_magenta_faint='#7c318f' \
         o_magenta_intense='#dd22dd' \
         o_cyan='#005e8b' \
         o_cyan_warmer='#3f578f' \
         o_cyan_cooler='#005f5f' \
         o_cyan_faint='#005077' \
         o_cyan_intense='#008899' \
         o_rust='#8a290f' \
         o_gold='#80601f' \
         o_olive='#56692d' \
         o_slate='#2f3f83' \
         o_indigo='#4a3a8a' \
         o_maroon='#731c52' \
         o_pink='#7b435c' \
         o_bg_red_intense='#ff8f88' \
         o_bg_green_intense='#8adf80' \
         o_bg_yellow_intense='#f3d000' \
         o_bg_blue_intense='#bfc9ff' \
         o_bg_magenta_intense='#dfa0f0' \
         o_bg_cyan_intense='#a4d5f9' \
         o_bg_red_subtle='#ffcfbf' \
         o_bg_green_subtle='#b3fabf' \
         o_bg_yellow_subtle='#fff576' \
         o_bg_blue_subtle='#ccdfff' \
         o_bg_magenta_subtle='#ffddff' \
         o_bg_cyan_subtle='#bfefff' \
         o_bg_red_nuanced='#ffe8e8' \
         o_bg_green_nuanced='#e0f6e0' \
         o_bg_yellow_nuanced='#f8f0d0' \
         o_bg_blue_nuanced='#ecedff' \
         o_bg_magenta_nuanced='#f8e6f5' \
         o_bg_cyan_nuanced='#e0f2fa' \
         o_bg_clay='#f1c8b5' \
         o_fg_clay='#63192a' \
         o_bg_ochre='#f0e3c0' \
         o_fg_ochre='#573a30' \
         o_bg_lavender='#dfcdfa' \
         o_fg_lavender='#443379' \
         o_bg_sage='#c0e7d4' \
         o_fg_sage='#124b41'

# from Protesilaos Stavrou's modus-vivendi theme
readonly v_bg_main='#000000' \
         v_bg_dim='#1e1e1e' \
         v_fg_main='#ffffff' \
         v_fg_dim='#989898' \
         v_fg_alt='#c6daff' \
         v_bg_active='#535353' \
         v_bg_inactive='#303030' \
         v_border='#646464' \
         v_red='#ff5f59' \
         v_red_warmer='#ff6b55' \
         v_red_cooler='#ff7f9f' \
         v_red_faint='#ff9580' \
         v_red_intense='#ff5f5f' \
         v_green='#44bc44' \
         v_green_warmer='#70b900' \
         v_green_cooler='#00c06f' \
         v_green_faint='#88ca9f' \
         v_green_intense='#44df44' \
         v_yellow='#d0bc00' \
         v_yellow_warmer='#fec43f' \
         v_yellow_cooler='#dfaf7a' \
         v_yellow_faint='#d2b580' \
         v_yellow_intense='#efef00' \
         v_blue='#2fafff' \
         v_blue_warmer='#79a8ff' \
         v_blue_cooler='#00bcff' \
         v_blue_faint='#82b0ec' \
         v_blue_intense='#338fff' \
         v_magenta='#feacd0' \
         v_magenta_warmer='#f78fe7' \
         v_magenta_cooler='#b6a0ff' \
         v_magenta_faint='#caa6df' \
         v_magenta_intense='#ff66ff' \
         v_cyan='#00d3d0' \
         v_cyan_warmer='#4ae2f0' \
         v_cyan_cooler='#6ae4b9' \
         v_cyan_faint='#9ac8e0' \
         v_cyan_intense='#00eff0' \
         v_rust='#db7b5f' \
         v_gold='#c0965b' \
         v_olive='#9cbd6f' \
         v_slate='#76afbf' \
         v_indigo='#9099d9' \
         v_maroon='#cf7fa7' \
         v_pink='#d09dc0' \
         v_bg_red_intense='#9d1f1f' \
         v_bg_green_intense='#2f822f' \
         v_bg_yellow_intense='#7a6100' \
         v_bg_blue_intense='#1640b0' \
         v_bg_magenta_intense='#7030af' \
         v_bg_cyan_intense='#2266ae' \
         v_bg_red_subtle='#620f2a' \
         v_bg_green_subtle='#00422a' \
         v_bg_yellow_subtle='#4a4000' \
         v_bg_blue_subtle='#242679' \
         v_bg_magenta_subtle='#552f5f' \
         v_bg_cyan_subtle='#004065' \
         v_bg_red_nuanced='#3a0c14' \
         v_bg_green_nuanced='#092f1f' \
         v_bg_yellow_nuanced='#381d0f' \
         v_bg_blue_nuanced='#12154a' \
         v_bg_magenta_nuanced='#2f0c3f' \
         v_bg_cyan_nuanced='#042837' \
         v_bg_clay='#49191a' \
         v_fg_clay='#f1b090' \
         v_bg_ochre='#462f20' \
         v_fg_ochre='#e0d09c' \
         v_bg_lavender='#38325c' \
         v_fg_lavender='#dfc0f0' \
         v_bg_sage='#143e32' \
         v_fg_sage='#c3e7d4'

substitute() {
    sed -n "/^\/\* BEGIN COLORS \*\/\$/,/^\/\* END COLORS \*\/\$/ {
                /^\/\*/! {
                    s/%bg-deftp-l%/${bg_deftp_l:?}/
                    s/%bg-deftp-r%/${bg_deftp_r:?}/
                    s/%bg-deftypefn-l%/${bg_deftypefn_l:?}/
                    s/%bg-deftypefn-r%/${bg_deftypefn_r:?}/
                    s/%bg-deftypevr-l%/${bg_deftypevr_l:?}/
                    s/%bg-deftypevr-r%/${bg_deftypevr_r:?}/
                    s/%bg-dim%/${bg_dim:?}/
                    s/%bg-inactive%/${bg_inactive:?}/
                    s/%bg-main%/${bg_main:?}/
                    s/%fg-alt%/${fg_alt:?}/
                    s/%fg-dim%/${fg_dim:?}/
                    s/%fg-main%/${fg_main:?}/
                    s/%border%/${border:?}/
                    s/%category-def%/${category_def:?}/
                    s/%char%/${char:?}/
                    s/%comment/${comment:?}/
                    s/%def-var%/${def_var:?}/
                    s/%emphasis%/${emphasis:?}/
                    s/%false%/${false:?}/
                    s/%link%/${link:?}/
                    s/%link-visited%/${link_visited:?}/
                    s/%ok%/${ok:?}/
                    s/%sexp-paren%/${sexp_paren:?}/
                    s/%string%/${string:?}/
                    s/%syntax%/${syntax:?}/
                    p
                }
           }" "$template"
}

# Light mode (default)
bg_deftp_l="$o_bg_ochre"6f
bg_deftp_r="$o_bg_ochre"3f
bg_deftypefn_l="$o_bg_blue_subtle"6f
bg_deftypefn_r="$o_bg_blue_subtle"3f
bg_deftypevr_l="$o_bg_clay"6f
bg_deftypevr_r="$o_bg_clay"3f
bg_dim="$o_bg_dim"
bg_inactive="$o_bg_inactive"
bg_main="$o_bg_main"
fg_alt="$o_fg_alt"
fg_dim="$o_fg_dim"
fg_main="$o_fg_main"
border="$o_border"
category_def="$o_fg_alt"
char="$o_red_faint"
comment="$o_fg_dim"
def_var="$o_magenta"
emphasis="$o_yellow_faint"
false="$o_fg_alt"
link="$o_blue_warmer"
link_visited="$link"
ok="$o_fg_alt"
sexp_paren="$o_fg_dim"
string="$o_green_cooler"
syntax="$o_magenta_cooler"

substitute

# Dark mode
bg_deftp_l="$v_bg_ochre"7f
bg_deftp_r="$v_bg_ochre"60
bg_deftypefn_l="$v_bg_blue_subtle"7f
bg_deftypefn_r="$v_bg_blue_subtle"60
bg_deftypevr_l="$v_bg_clay"7f
bg_deftypevr_r="$v_bg_clay"60
bg_dim="$v_bg_dim"
bg_inactive="$v_bg_inactive"
bg_main="$v_bg_main"
fg_alt="$v_fg_alt"
fg_dim="$v_fg_dim"
fg_main="$v_fg_main"
border="$v_border"
category_def="$v_fg_alt"
char="$v_red_faint"
comment="$v_fg_dim"
def_var="$v_magenta"
emphasis="$v_yellow_faint"
false="$v_fg_alt"
link="$v_blue_warmer"
link_visited="$link"
ok="$v_fg_alt"
sexp_paren="$v_fg_dim"
string="$v_green_cooler"
syntax="$v_magenta_cooler"

echo
echo '@media (prefers-color-scheme: dark) {'
substitute | sed 's/^/    /'
echo '}'

sed -n '/^\/\* END COLORS \*\/$/,$ {
            /^\/\* END COLORS \*\/$/!p
        }' "$template"
